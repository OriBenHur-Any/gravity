syntax = "proto3";

package installer;

import "google/protobuf/empty.proto";
import "gogo.proto";

// Agent defines a service to install a cluster
service Agent {
    // Execute runs installer operation to completion
    rpc Execute(ExecuteRequest) returns (stream ProgressResponse);

    // GetState determines the installer state
    rpc GetState(google.protobuf.Empty) returns (StateResponse);

    // Shutdown requests that the installer exits
    rpc Shutdown(ShutdownRequest) returns (ShutdownResponse);

    // Abort requests that the installer service aborts and cleans up
    // the state of the operation
    rpc Abort(AbortRequest) returns (AbortResponse);
}

// StateResponse describes the response to the state query
message StateResponse {
    // State defines the state of the agent.
    enum State {
        // Idle state is the agent is not doing any work
        IDLE = 0 [(gogoproto.enumvalue_customname) = "Idle"];
        // Active state is when the agent is executing the operation
        ACTIVE = 1 [(gogoproto.enumvalue_customname) = "Active"];
    }
    // State describes the state of the agent
    State state = 2;
}

// ExecuteRequest describes a request to execute install operation
message ExecuteRequest {
    message Phase {
        // ID specifies the phase ID
        string id = 1 [(gogoproto.customname) = "ID"];
        // Key identifies the operation
        OperationKey key = 2;
        // Rollback specifies whether this is a rollback
        bool rollback = 3;
        // Force specifies whether the phase execution/rollback should be rerun
        // regardless of phase state
        bool force = 4;
    }
    // Phase optionally specifies the configuration for executing or rolling
    // back a specific phase.
    // If unspecified, the operation is executed from the beginning
    Phase phase = 1;
}

// ShutdownRequest describes a request to shut down the process
message ShutdownRequest {
}

// ShutdownResponse describes the server response to the shut down request
message ShutdownResponse {
}

// AbortRequest describes a request to abort the operation and clean up
message AbortRequest {
}

// AbortResponse describes the server response to the abort request
message AbortResponse {
    // Error specifies the error from the abort handler
    Error error = 1;
}

// ProgressResponse describes a single progress step
message ProgressResponse {
    // Message specifies the progress message
    string message = 1;
    // Status defines the status of this progress message.
    // If the status is one of (COMPLETED, ABORTED), this response is the last response sent
    enum Status {
        UNKNOWN = 0 [(gogoproto.enumvalue_customname) = "Unknown"];
        // COMPLETED status indicates that the operation has successfully completed.
        // This status is terminal - no more progress messages will follow
        COMPLETED = 1 [(gogoproto.enumvalue_customname) = "Completed"];
        // ABORTED status indicates that the operation has been aborted.
        // This status is terminal - no more progress messages will follow
        ABORTED = 2 [(gogoproto.enumvalue_customname) = "Aborted"];
    }
    // Status describes the status of this response
    Status status = 2;
    // Error specifies the error for this progress step
    Error error = 3;
}

// Error represents an error in the operation
message Error {
    // Message specifies the error message
    string message = 1;
}

// OperationKey describes a cluster operation
message OperationKey {
    // AccountID refers to the account this operation belongs to
    string account_id = 1 [(gogoproto.customname) = "AccountID"];
    // ClusterName identifies the cluster for the operation
    string cluster_name = 2 [(gogoproto.customname) = "ClusterName"];
    // ID specifies the operation ID
    string id = 3 [(gogoproto.customname) = "ID"];
}
